# TODO: Use VCPKG_INSTALLATION_ROOT and PROGRAMFILES
# TODO: Use binary caching https://devblogs.microsoft.com/cppblog/vcpkg-accelerate-your-team-development-environment-with-binary-caching-and-manifests/
name: Build and Test

on:
  push:

jobs:
  build-and-test:
    runs-on: windows-latest
    env:
      # Needed by vcpkg to find the binary cache and
      # restore dependencies like Boost faster.
      VCPKG_BINARY_SOURCES: clear;x-gha,readwrite
    steps:
      - name: Install Doxygen
        uses: ssciwr/doxygen-install@v1.6.3

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Rebuilding all vcpkg dependencies at each commit is time consuming,
      # in particular when Boost is a dependency. So cache binaries.
      # https://learn.microsoft.com/en-us/vcpkg/consume/binary-caching-github-actions-cache
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Build (MSVC)
        uses: lukka/run-cmake@v10
        env:
          CMAKE_TOOLCHAIN_FILE: C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          LLVM_PATH: C:/Program Files/LLVM/bin/
        with:
          workflowPreset: x64-Debug-MSVC

      - name: Build (Clang)
        uses: lukka/run-cmake@v10
        env:
          CMAKE_TOOLCHAIN_FILE: C:/vcpkg/scripts/buildsystems/vcpkg.cmake
          LLVM_PATH: C:/Program Files/LLVM/bin/
        with:
          workflowPreset: x64-Debug-Clang
          
      - name: Install OpenCppCoverage
        run: |
          $url = "https://github.com/OpenCppCoverage/OpenCppCoverage/releases/download/release-0.9.9.0/OpenCppCoverageSetup-x64-0.9.9.0.exe"
          $output = "OpenCppCoverageSetup.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          Start-Process -FilePath $output -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait

      - name: Run unit tests
        run: >
          "C:\Program Files\OpenCppCoverage\OpenCppCoverage.exe"
          --working_dir "${{ github.workspace }}/out/x64-Debug-MSVC"
          --export_type "cobertura:${{ github.workspace }}/out/x64-Debug-MSVC/raw_coverage.xml"
          --cover_children
          --sources "${{ github.workspace }}"
          -- ctest -j --verbose -T Test

      - name: Analyze (cppcheck)
        uses: deep5050/cppcheck-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          other_options: >
            --xml
            --project="${{ github.workspace }}/out/x64-Debug-Clang/compile_commands.json"
            --project-configuration=Debug|x64
            --output-file=out/x64-Debug-Clang/cppcheck.xml
            -D__cppcheck__

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
